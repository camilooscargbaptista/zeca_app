name: ðŸš€ Deploy Completo - Android + iOS

on:
  push:
    tags:
      - 'v*.*.*'  # Ex: v1.0.3, v2.1.0
  workflow_dispatch:
    inputs:
      version:
        description: 'VersÃ£o (ex: 1.0.3)'
        required: true
      build_number:
        description: 'Build number (ex: 65)'
        required: true
      android_track:
        description: 'Track Android'
        required: false
        default: 'internal'
        type: choice
        options:
          - internal
          - alpha
          - beta
          - production
      skip_ios_upload:
        description: 'Pular upload iOS'
        required: false
        default: false
        type: boolean

jobs:
  deploy-android:
    name: ðŸ“± Deploy Android
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.0'
          channel: 'stable'

      - name: ðŸ“¦ Instalar dependÃªncias
        run: |
          flutter pub get
          
      - name: ðŸ”¨ Gerar cÃ³digo
        run: |
          # Tentar gerar cÃ³digo. Se falhar por causa do analyzer antigo, 
          # verificar se os arquivos gerados jÃ¡ existem (commitados)
          set +e  # NÃ£o falhar em caso de erro
          flutter pub run build_runner build --delete-conflicting-outputs
          BUILD_RUNNER_EXIT=$?
          set -e  # Voltar a falhar em caso de erro
          
          if [ $BUILD_RUNNER_EXIT -ne 0 ]; then
            echo "âš ï¸ Build runner falhou (exit code: $BUILD_RUNNER_EXIT)"
            echo "ðŸ” Verificando se arquivos gerados jÃ¡ existem..."
            
            # Verificar arquivos crÃ­ticos gerados
            CRITICAL_FILES=(
              "lib/core/di/injection.config.dart"
              "lib/features/home/data/models/vehicle_model.g.dart"
              "lib/features/home/data/models/company_model.g.dart"
            )
            
            ALL_EXIST=true
            for file in "${CRITICAL_FILES[@]}"; do
              if [ ! -f "$file" ]; then
                echo "âŒ Arquivo crÃ­tico nÃ£o encontrado: $file"
                ALL_EXIST=false
              fi
            done
            
            if [ "$ALL_EXIST" = true ]; then
              echo "âœ… Arquivos gerados encontrados, continuando com build..."
            else
              echo "âŒ Arquivos gerados nÃ£o encontrados! Build precisa do cÃ³digo gerado."
              exit 1
            fi
          else
            echo "âœ… Build runner completou com sucesso!"
          fi

      - name: ðŸ” Verificar versÃ£o
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
            BUILD_NUMBER="${{ github.event.inputs.build_number }}"
          else
            VERSION=$(echo "${{ github.ref }}" | sed 's/refs\/tags\/v//')
            BUILD_NUMBER=$(grep "^version:" pubspec.yaml | sed 's/version: //' | cut -d'+' -f2)
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT

      - name: ðŸ“ Atualizar versÃ£o
        run: |
          sed -i "s/^version:.*/version: ${{ steps.version.outputs.version }}+${{ steps.version.outputs.build_number }}/" pubspec.yaml

      - name: ðŸ” Configurar assinatura Android
        run: |
          mkdir -p android/app
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android/app/zeca-release-key.jks
          cat > android/key.properties << EOF
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          storeFile=zeca-release-key.jks
          EOF

      - name: ðŸ—ï¸ Build AAB
        run: |
          flutter clean
          flutter build appbundle --release

      - name: ðŸ“¤ Upload para Google Play
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: com.zeca.app
          releaseFiles: build/app/outputs/bundle/release/app-release.aab
          track: ${{ github.event.inputs.android_track || 'internal' }}
          status: completed

  deploy-ios:
    name: ðŸŽ Deploy iOS
    runs-on: macos-latest
    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.0'
          channel: 'stable'

      - name: ðŸ“¦ Instalar dependÃªncias
        run: |
          flutter pub get
          
      - name: ðŸ”¨ Gerar cÃ³digo
        run: |
          # Tentar gerar cÃ³digo. Se falhar por causa do analyzer antigo, 
          # verificar se os arquivos gerados jÃ¡ existem (commitados)
          set +e  # NÃ£o falhar em caso de erro
          flutter pub run build_runner build --delete-conflicting-outputs
          BUILD_RUNNER_EXIT=$?
          set -e  # Voltar a falhar em caso de erro
          
          if [ $BUILD_RUNNER_EXIT -ne 0 ]; then
            echo "âš ï¸ Build runner falhou (exit code: $BUILD_RUNNER_EXIT)"
            echo "ðŸ” Verificando se arquivos gerados jÃ¡ existem..."
            
            # Verificar arquivos crÃ­ticos gerados
            CRITICAL_FILES=(
              "lib/core/di/injection.config.dart"
              "lib/features/home/data/models/vehicle_model.g.dart"
              "lib/features/home/data/models/company_model.g.dart"
            )
            
            ALL_EXIST=true
            for file in "${CRITICAL_FILES[@]}"; do
              if [ ! -f "$file" ]; then
                echo "âŒ Arquivo crÃ­tico nÃ£o encontrado: $file"
                ALL_EXIST=false
              fi
            done
            
            if [ "$ALL_EXIST" = true ]; then
              echo "âœ… Arquivos gerados encontrados, continuando com build..."
            else
              echo "âŒ Arquivos gerados nÃ£o encontrados! Build precisa do cÃ³digo gerado."
              exit 1
            fi
          else
            echo "âœ… Build runner completou com sucesso!"
          fi
          cd ios && pod install && cd ..

      - name: ðŸ” Verificar versÃ£o
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
            BUILD_NUMBER="${{ github.event.inputs.build_number }}"
          else
            VERSION=$(echo "${{ github.ref }}" | sed 's/refs\/tags\/v//')
            BUILD_NUMBER=$(grep "^version:" pubspec.yaml | sed 's/version: //' | cut -d'+' -f2)
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT

      - name: ðŸ“ Atualizar versÃ£o
        run: |
          sed -i '' "s/^version:.*/version: ${{ steps.version.outputs.version }}+${{ steps.version.outputs.build_number }}/" pubspec.yaml
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString ${{ steps.version.outputs.version }}" ios/Runner/Info.plist
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion ${{ steps.version.outputs.build_number }}" ios/Runner/Info.plist

      - name: ðŸ” Importar certificados
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.IOS_P12_CERTIFICATE_BASE64 }}
          p12-password: ${{ secrets.IOS_P12_PASSWORD }}

      - name: ðŸ—ï¸ Build IPA
        run: |
          flutter clean
          flutter build ipa --release

      - name: ðŸ“¤ Upload para App Store
        if: github.event.inputs.skip_ios_upload != 'true'
        uses: apple-actions/upload-testflight-build@v1
        with:
          app-path: build/ios/ipa/*.ipa
          issuer-id: ${{ secrets.APPSTORE_ISSUER_ID }}
          api-key-id: ${{ secrets.APPSTORE_API_KEY_ID }}
          api-private-key: ${{ secrets.APPSTORE_API_PRIVATE_KEY }}

  notify:
    name: ðŸ“§ NotificaÃ§Ã£o Final
    needs: [deploy-android, deploy-ios]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: ðŸ“Š Resumo
        run: |
          echo "## ðŸš€ Deploy ConcluÃ­do" >> $GITHUB_STEP_SUMMARY
          echo "### Android: ${{ needs.deploy-android.result }}" >> $GITHUB_STEP_SUMMARY
          echo "### iOS: ${{ needs.deploy-ios.result }}" >> $GITHUB_STEP_SUMMARY

