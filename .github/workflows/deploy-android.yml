name: ðŸš€ Deploy Android - Google Play Store

on:
  push:
    tags:
      - 'v*.*.*'  # Ex: v1.0.3, v2.1.0
  workflow_dispatch:
    inputs:
      version:
        description: 'VersÃ£o (ex: 1.0.3)'
        required: true
      build_number:
        description: 'Build number (ex: 65)'
        required: true
      track:
        description: 'Track de publicaÃ§Ã£o'
        required: false
        default: 'internal'
        type: choice
        options:
          - internal
          - alpha
          - beta
          - production

env:
  FLUTTER_VERSION: '3.27.0'

jobs:
  deploy-android:
    name: ðŸ“± Build e Deploy Android
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'

      - name: ðŸ“¦ Instalar dependÃªncias
        run: |
          flutter pub get
          flutter pub run build_runner build --delete-conflicting-outputs || true

      - name: ðŸ” Verificar versÃ£o
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
            BUILD_NUMBER="${{ github.event.inputs.build_number }}"
          else
            # Extrair versÃ£o da tag (ex: v1.0.3 -> 1.0.3)
            VERSION=$(echo "${{ github.ref }}" | sed 's/refs\/tags\/v//')
            # Ler build number do pubspec.yaml
            BUILD_NUMBER=$(grep "^version:" pubspec.yaml | sed 's/version: //' | cut -d'+' -f2)
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "ðŸ“± VersÃ£o: $VERSION+$BUILD_NUMBER"

      - name: ðŸ“ Atualizar versÃ£o no pubspec.yaml
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          BUILD_NUMBER="${{ steps.version.outputs.build_number }}"
          sed -i "s/^version:.*/version: $VERSION+$BUILD_NUMBER/" pubspec.yaml
          echo "âœ… VersÃ£o atualizada: $VERSION+$BUILD_NUMBER"

      - name: ðŸ” Configurar assinatura Android
        run: |
          # Criar diretÃ³rio para keystore
          mkdir -p android/app
          
          # Decodificar keystore do secret
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android/app/zeca-release-key.jks
          
          # Criar key.properties na raiz do android (onde build.gradle espera)
          cat > android/key.properties << EOF
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          storeFile=app/zeca-release-key.jks
          EOF
          
          echo "âœ… Assinatura configurada"
          echo "ðŸ“ Keystore: android/app/zeca-release-key.jks"
          echo "ðŸ“ Key properties: android/key.properties"

      - name: ðŸ—ï¸ Build App Bundle (AAB)
        run: |
          flutter clean
          flutter build appbundle --release
          echo "âœ… AAB gerado com sucesso"

      - name: ðŸ“Š Verificar AAB gerado
        run: |
          AAB_PATH="build/app/outputs/bundle/release/app-release.aab"
          if [ -f "$AAB_PATH" ]; then
            SIZE=$(du -h "$AAB_PATH" | cut -f1)
            echo "âœ… AAB gerado: $AAB_PATH ($SIZE)"
            ls -lh "$AAB_PATH"
          else
            echo "âŒ AAB nÃ£o encontrado!"
            exit 1
          fi

      - name: ðŸ“¤ Upload para Google Play Store
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: com.zeca.app
          releaseFiles: build/app/outputs/bundle/release/app-release.aab
          track: ${{ github.event.inputs.track || 'internal' }}
          status: completed
          inAppUpdatePriority: 2
          whatsNewDirectory: fastlane/metadata/android/pt-BR/changelogs
          mappingFile: build/app/outputs/mapping/release/mapping.txt

      - name: ðŸ“ Criar Release no GitHub
        if: github.event_name == 'push'
        uses: softprops/action-gh-release@v1
        with:
          files: build/app/outputs/bundle/release/app-release.aab
          body: |
            ## ðŸš€ Release Android ${{ steps.version.outputs.version }}
            
            **Build Number:** ${{ steps.version.outputs.build_number }}
            **Track:** ${{ github.event.inputs.track || 'internal' }}
            
            ### ðŸ“¦ Arquivos
            - App Bundle (AAB) anexado
            
            ### âœ… Status
            - âœ… Build concluÃ­do
            - âœ… Upload para Google Play Store concluÃ­do
            - âœ… Enviado para track: ${{ github.event.inputs.track || 'internal' }}
            
            **PrÃ³ximos passos:**
            1. Aguardar processamento do Google Play (10-30 minutos)
            2. Verificar status na Play Console
            3. Se necessÃ¡rio, promover para produÃ§Ã£o
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“§ NotificaÃ§Ã£o de sucesso
        if: success()
        run: |
          echo "âœ… Deploy Android concluÃ­do com sucesso!"
          echo "ðŸ“± VersÃ£o: ${{ steps.version.outputs.version }}+${{ steps.version.outputs.build_number }}"
          echo "ðŸ“¦ Track: ${{ github.event.inputs.track || 'internal' }}"
          echo "ðŸ”— Play Console: https://play.google.com/console/u/0/developers"

      - name: âŒ NotificaÃ§Ã£o de erro
        if: failure()
        run: |
          echo "âŒ Deploy Android falhou!"
          echo "Verifique os logs acima para mais detalhes"

